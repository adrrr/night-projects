<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Music Box</title>
<style>
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#1a1410;--surface:#2a2218;--surface2:#3a3228;--gold:#d4a843;--gold-dim:#8a6e2a;
  --gold-glow:rgba(212,168,67,.6);--wood:#5c3d1e;--wood-light:#8b6240;
  --pin:#f0d48a;--pin-active:#ffe8a0;--playhead:rgba(255,180,60,.35);
  --text:#e8dcc8;--text-dim:#9a8e7a;--radius:10px;
}
html,body{width:100%;height:100%;overflow:hidden;background:var(--bg);color:var(--text);
  font-family:'Segoe UI',system-ui,-apple-system,sans-serif;touch-action:none;
  -webkit-tap-highlight-color:transparent;user-select:none}

#app{display:flex;flex-direction:column;height:100%;height:100dvh;max-width:600px;margin:0 auto}

/* Header */
header{padding:12px 16px 8px;text-align:center;flex-shrink:0}
header h1{font-size:1.3rem;font-weight:300;letter-spacing:.3em;text-transform:uppercase;
  color:var(--gold);text-shadow:0 0 20px rgba(212,168,67,.3)}
header p{font-size:.65rem;color:var(--text-dim);letter-spacing:.15em;margin-top:2px}

/* Grid area */
#grid-container{flex:1;min-height:0;position:relative;margin:6px 10px;
  border-radius:var(--radius);overflow:hidden;
  background:linear-gradient(145deg,var(--surface),var(--surface2));
  box-shadow:inset 0 2px 8px rgba(0,0,0,.4),0 1px 0 rgba(255,255,255,.03)}

#note-labels{position:absolute;left:0;top:0;bottom:0;width:36px;z-index:5;
  display:flex;flex-direction:column;
  background:linear-gradient(90deg,var(--surface) 70%,transparent)}
.note-label{flex:1;display:flex;align-items:center;justify-content:center;
  font-size:.6rem;color:var(--text-dim);font-weight:500;letter-spacing:.05em}

#grid-scroll{position:absolute;left:36px;top:0;right:0;bottom:0;overflow-x:auto;overflow-y:hidden;
  -webkit-overflow-scrolling:touch;scrollbar-width:none}
#grid-scroll::-webkit-scrollbar{display:none}

#grid{display:grid;height:100%;position:relative}

.cell{position:relative;border:1px solid rgba(255,255,255,.04);cursor:pointer;
  transition:background .15s;min-width:0;min-height:0}
.cell:active{background:rgba(212,168,67,.08)}
.cell.pinned::after{content:'';position:absolute;
  top:50%;left:50%;transform:translate(-50%,-50%);
  width:60%;height:60%;max-width:22px;max-height:22px;border-radius:50%;
  background:radial-gradient(circle at 35% 35%,var(--pin-active),var(--pin) 50%,var(--gold-dim));
  box-shadow:0 0 6px var(--gold-glow),0 1px 3px rgba(0,0,0,.5),inset 0 -1px 2px rgba(0,0,0,.3);
  transition:transform .15s ease,box-shadow .15s ease}
.cell.pinned.triggered::after{
  transform:translate(-50%,-50%) scale(1.3);
  box-shadow:0 0 16px var(--gold-glow),0 0 30px rgba(212,168,67,.3),0 1px 3px rgba(0,0,0,.5);
  background:radial-gradient(circle at 35% 35%,#fff,var(--pin-active) 40%,var(--gold))}

/* Playhead */
#playhead{position:absolute;top:0;bottom:0;width:3px;z-index:4;pointer-events:none;
  background:var(--gold);box-shadow:0 0 12px var(--gold-glow),0 0 30px rgba(212,168,67,.2);
  transition:none;will-change:left}
#playhead::before{content:'';position:absolute;top:-4px;left:-4px;width:11px;height:11px;
  border-radius:50%;background:var(--gold);box-shadow:0 0 8px var(--gold-glow)}
#playhead::after{content:'';position:absolute;bottom:-4px;left:-4px;width:11px;height:11px;
  border-radius:50%;background:var(--gold);box-shadow:0 0 8px var(--gold-glow)}

/* Column highlight */
.col-highlight{position:absolute;top:0;bottom:0;z-index:2;pointer-events:none;
  background:var(--playhead);opacity:0;transition:opacity .08s}
.col-highlight.active{opacity:1}

/* Controls */
#controls{flex-shrink:0;padding:8px 10px 10px;display:flex;flex-direction:column;gap:8px}

.ctrl-row{display:flex;gap:8px;align-items:center;justify-content:center;flex-wrap:wrap}

.btn{background:var(--surface2);color:var(--text);border:1px solid rgba(255,255,255,.08);
  border-radius:8px;padding:10px 16px;font-size:.75rem;letter-spacing:.08em;cursor:pointer;
  transition:all .15s;display:flex;align-items:center;gap:6px;white-space:nowrap;
  min-height:42px;text-transform:uppercase;font-weight:500}
.btn:active{background:var(--gold-dim);transform:scale(.96)}
.btn.primary{background:var(--gold-dim);color:#fff;border-color:var(--gold)}
.btn.primary.playing{background:#6a3a1a;border-color:#a05a2a}
.btn svg{width:16px;height:16px;fill:currentColor}

.slider-group{display:flex;align-items:center;gap:8px;flex:1;min-width:140px;max-width:220px}
.slider-group label{font-size:.6rem;color:var(--text-dim);letter-spacing:.1em;text-transform:uppercase;white-space:nowrap}
.slider-group input[type=range]{flex:1;height:4px;-webkit-appearance:none;appearance:none;
  background:var(--surface2);border-radius:2px;outline:none}
.slider-group input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:18px;height:18px;
  border-radius:50%;background:var(--gold);cursor:pointer;box-shadow:0 0 6px var(--gold-glow)}
.slider-group input[type=range]::-moz-range-thumb{width:18px;height:18px;border:none;
  border-radius:50%;background:var(--gold);cursor:pointer}
.slider-group .val{font-size:.65rem;color:var(--gold);min-width:28px;text-align:right}

select.instrument-select{background:var(--surface2);color:var(--text);
  border:1px solid rgba(255,255,255,.08);border-radius:8px;padding:10px 12px;
  font-size:.75rem;letter-spacing:.05em;cursor:pointer;min-height:42px;
  -webkit-appearance:none;appearance:none;
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M0 0l5 6 5-6z' fill='%239a8e7a'/%3E%3C/svg%3E");
  background-repeat:no-repeat;background-position:right 10px center;padding-right:28px}

/* Ripple on pin place */
@keyframes ripple{0%{transform:translate(-50%,-50%) scale(0);opacity:.6}
100%{transform:translate(-50%,-50%) scale(2.5);opacity:0}}
.cell .ripple{position:absolute;top:50%;left:50%;width:100%;height:100%;
  border-radius:50%;background:var(--gold-glow);pointer-events:none;
  animation:ripple .4s ease-out forwards}

/* Pattern info */
#pattern-info{text-align:center;padding:2px 0 6px;flex-shrink:0}
#pattern-info span{font-size:.55rem;color:var(--text-dim);letter-spacing:.1em}

/* Toast */
#toast{position:fixed;bottom:80px;left:50%;transform:translateX(-50%) translateY(20px);
  background:var(--surface2);color:var(--gold);padding:10px 20px;border-radius:20px;
  font-size:.75rem;letter-spacing:.05em;opacity:0;transition:all .3s;pointer-events:none;
  border:1px solid rgba(212,168,67,.2);z-index:100;white-space:nowrap}
#toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
</style>
</head>
<body>
<div id="app">
  <header>
    <h1>Music Box</h1>
    <p>Tap to place pins &middot; Press play to listen</p>
  </header>

  <div id="grid-container">
    <div id="note-labels"></div>
    <div id="grid-scroll">
      <div id="grid"></div>
      <div id="playhead" style="display:none"></div>
    </div>
  </div>

  <div id="controls">
    <div class="ctrl-row">
      <button class="btn primary" id="btn-play">
        <svg id="icon-play" viewBox="0 0 24 24"><polygon points="6,3 20,12 6,21"/></svg>
        <svg id="icon-pause" viewBox="0 0 24 24" style="display:none"><rect x="5" y="3" width="4" height="18"/><rect x="15" y="3" width="4" height="18"/></svg>
        <span>Play</span>
      </button>
      <select class="instrument-select" id="instrument-select">
        <option value="musicbox">Music Box</option>
        <option value="piano">Soft Piano</option>
        <option value="marimba">Marimba</option>
      </select>
      <button class="btn" id="btn-random">Randomize</button>
      <button class="btn" id="btn-clear">Clear</button>
    </div>
    <div class="ctrl-row">
      <div class="slider-group">
        <label>Tempo</label>
        <input type="range" id="tempo-slider" min="40" max="240" value="120">
        <span class="val" id="tempo-val">120</span>
      </div>
      <button class="btn" id="btn-share">Share</button>
    </div>
  </div>
  <div id="pattern-info"><span id="pin-count">0 pins</span></div>
</div>

<div id="toast"></div>

<script>
(function(){
'use strict';

// ─── Config ───
const ROWS = 13; // notes
const COLS = 32; // steps
const NOTES_PENTATONIC = ['C6','A5','G5','E5','D5','C5','A4','G4','E4','D4','C4','A3','G3'];
const NOTE_LABELS = ['C6','A5','G5','E5','D5','C5','A4','G4','E4','D4','C4','A3','G3'];

function noteToFreq(note) {
  const notes = {C:0,D:2,E:4,F:5,G:7,A:9,B:11};
  const match = note.match(/^([A-G]#?)(\d)$/);
  if (!match) return 440;
  const n = notes[match[1]] || 0;
  const oct = parseInt(match[2]);
  return 440 * Math.pow(2, (n - 9) / 12 + (oct - 4));
}

const FREQS = NOTES_PENTATONIC.map(noteToFreq);

// ─── State ───
let grid = Array.from({length: ROWS}, () => new Uint8Array(COLS));
let playing = false;
let currentCol = 0;
let bpm = 120;
let instrument = 'musicbox';
let audioCtx = null;
let lastStepTime = 0;
let animId = null;
let playheadX = 0;

// ─── DOM refs ───
const gridEl = document.getElementById('grid');
const gridScroll = document.getElementById('grid-scroll');
const playheadEl = document.getElementById('playhead');
const noteLabelsEl = document.getElementById('note-labels');
const btnPlay = document.getElementById('btn-play');
const iconPlay = document.getElementById('icon-play');
const iconPause = document.getElementById('icon-pause');
const tempoSlider = document.getElementById('tempo-slider');
const tempoVal = document.getElementById('tempo-val');
const instrumentSelect = document.getElementById('instrument-select');
const btnClear = document.getElementById('btn-clear');
const btnRandom = document.getElementById('btn-random');
const btnShare = document.getElementById('btn-share');
const pinCountEl = document.getElementById('pin-count');
const toastEl = document.getElementById('toast');

// ─── Build Grid ───
function buildGrid() {
  const cellW = Math.max(32, Math.min(44, (window.innerWidth - 56) / 16));
  const cellH = Math.max(28, (gridEl.parentElement.clientHeight) / ROWS);

  gridEl.style.gridTemplateRows = `repeat(${ROWS}, 1fr)`;
  gridEl.style.gridTemplateColumns = `repeat(${COLS}, ${cellW}px)`;
  gridEl.style.width = `${COLS * cellW}px`;
  gridEl.innerHTML = '';

  // Note labels
  noteLabelsEl.innerHTML = '';
  for (let r = 0; r < ROWS; r++) {
    const lbl = document.createElement('div');
    lbl.className = 'note-label';
    lbl.textContent = NOTE_LABELS[r];
    noteLabelsEl.appendChild(lbl);
  }

  // Column highlights
  for (let c = 0; c < COLS; c++) {
    const hl = document.createElement('div');
    hl.className = 'col-highlight';
    hl.dataset.col = c;
    hl.style.left = `${c * cellW}px`;
    hl.style.width = `${cellW}px`;
    gridEl.appendChild(hl);
  }

  // Cells
  for (let r = 0; r < ROWS; r++) {
    for (let c = 0; c < COLS; c++) {
      const cell = document.createElement('div');
      cell.className = 'cell' + (grid[r][c] ? ' pinned' : '');
      cell.dataset.row = r;
      cell.dataset.col = c;
      cell.style.gridRow = r + 1;
      cell.style.gridColumn = c + 1;
      gridEl.appendChild(cell);
    }
  }

  updatePinCount();
}

// ─── Cell interaction ───
let pointerDown = false;
let pointerAction = null; // 'place' or 'remove'

gridEl.addEventListener('pointerdown', e => {
  const cell = e.target.closest('.cell');
  if (!cell) return;
  e.preventDefault();
  pointerDown = true;
  const r = +cell.dataset.row, c = +cell.dataset.col;
  pointerAction = grid[r][c] ? 'remove' : 'place';
  togglePin(cell, r, c, pointerAction);
  cell.setPointerCapture && false; // don't capture so we can enter other cells
});

gridEl.addEventListener('pointerenter', e => {
  if (!pointerDown) return;
  const cell = e.target.closest('.cell');
  if (!cell) return;
  const r = +cell.dataset.row, c = +cell.dataset.col;
  togglePin(cell, r, c, pointerAction);
}, true);

// Use event delegation with pointermove for drag across cells
gridEl.addEventListener('pointermove', e => {
  if (!pointerDown) return;
  const el = document.elementFromPoint(e.clientX, e.clientY);
  if (!el) return;
  const cell = el.closest('.cell');
  if (!cell) return;
  const r = +cell.dataset.row, c = +cell.dataset.col;
  togglePin(cell, r, c, pointerAction);
});

window.addEventListener('pointerup', () => { pointerDown = false; pointerAction = null; savePattern(); });
window.addEventListener('pointercancel', () => { pointerDown = false; pointerAction = null; });

function togglePin(cell, r, c, action) {
  if (action === 'place' && !grid[r][c]) {
    grid[r][c] = 1;
    cell.classList.add('pinned');
    addRipple(cell);
    playPreview(r);
  } else if (action === 'remove' && grid[r][c]) {
    grid[r][c] = 0;
    cell.classList.remove('pinned');
  }
  updatePinCount();
}

function addRipple(cell) {
  const rip = document.createElement('div');
  rip.className = 'ripple';
  cell.appendChild(rip);
  rip.addEventListener('animationend', () => rip.remove());
}

function updatePinCount() {
  let count = 0;
  for (let r = 0; r < ROWS; r++) for (let c = 0; c < COLS; c++) if (grid[r][c]) count++;
  pinCountEl.textContent = count + ' pin' + (count !== 1 ? 's' : '');
}

// ─── Audio ───
function ensureAudio() {
  if (!audioCtx) {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  }
  if (audioCtx.state === 'suspended') audioCtx.resume();
}

function playNote(freq, time, inst) {
  if (!audioCtx) return;
  const ctx = audioCtx;
  const t = time || ctx.currentTime;
  const gain = ctx.createGain();
  gain.connect(ctx.destination);

  if (inst === 'musicbox') {
    // Bright bell-like: two detuned sine + harmonic
    const osc1 = ctx.createOscillator();
    const osc2 = ctx.createOscillator();
    const osc3 = ctx.createOscillator();
    osc1.type = 'sine';
    osc1.frequency.setValueAtTime(freq, t);
    osc2.type = 'sine';
    osc2.frequency.setValueAtTime(freq * 2.001, t);
    osc3.type = 'sine';
    osc3.frequency.setValueAtTime(freq * 3.998, t);

    const g1 = ctx.createGain();
    const g2 = ctx.createGain();
    const g3 = ctx.createGain();
    g1.gain.setValueAtTime(0.25, t);
    g2.gain.setValueAtTime(0.12, t);
    g3.gain.setValueAtTime(0.04, t);

    osc1.connect(g1); g1.connect(gain);
    osc2.connect(g2); g2.connect(gain);
    osc3.connect(g3); g3.connect(gain);

    gain.gain.setValueAtTime(0.35, t);
    gain.gain.exponentialRampToValueAtTime(0.001, t + 1.4);

    [osc1, osc2, osc3].forEach(o => { o.start(t); o.stop(t + 1.5); });
  } else if (inst === 'piano') {
    // Soft piano: filtered triangle + sine
    const osc1 = ctx.createOscillator();
    const osc2 = ctx.createOscillator();
    osc1.type = 'triangle';
    osc1.frequency.setValueAtTime(freq, t);
    osc2.type = 'sine';
    osc2.frequency.setValueAtTime(freq, t);

    const filter = ctx.createBiquadFilter();
    filter.type = 'lowpass';
    filter.frequency.setValueAtTime(freq * 4, t);
    filter.frequency.exponentialRampToValueAtTime(freq * 1.5, t + 0.8);
    filter.Q.setValueAtTime(1, t);

    const g1 = ctx.createGain();
    const g2 = ctx.createGain();
    g1.gain.setValueAtTime(0.2, t);
    g2.gain.setValueAtTime(0.15, t);

    osc1.connect(g1); g1.connect(filter);
    osc2.connect(g2); g2.connect(filter);
    filter.connect(gain);

    gain.gain.setValueAtTime(0.3, t);
    gain.gain.setValueAtTime(0.3, t + 0.01);
    gain.gain.exponentialRampToValueAtTime(0.001, t + 2.0);

    [osc1, osc2].forEach(o => { o.start(t); o.stop(t + 2.1); });
  } else if (inst === 'marimba') {
    // Marimba: sine with fast attack/decay + sub harmonic
    const osc1 = ctx.createOscillator();
    const osc2 = ctx.createOscillator();
    osc1.type = 'sine';
    osc1.frequency.setValueAtTime(freq, t);
    osc2.type = 'sine';
    osc2.frequency.setValueAtTime(freq * 4, t);

    const g1 = ctx.createGain();
    const g2 = ctx.createGain();
    g1.gain.setValueAtTime(0.3, t);
    g2.gain.setValueAtTime(0.08, t);
    g2.gain.exponentialRampToValueAtTime(0.001, t + 0.15);

    osc1.connect(g1); g1.connect(gain);
    osc2.connect(g2); g2.connect(gain);

    gain.gain.setValueAtTime(0.001, t);
    gain.gain.linearRampToValueAtTime(0.35, t + 0.005);
    gain.gain.exponentialRampToValueAtTime(0.001, t + 0.8);

    [osc1, osc2].forEach(o => { o.start(t); o.stop(t + 0.9); });
  }
}

function playPreview(row) {
  ensureAudio();
  playNote(FREQS[row], audioCtx.currentTime, instrument);
}

// ─── Playback ───
function startPlayback() {
  ensureAudio();
  playing = true;
  btnPlay.classList.add('playing');
  iconPlay.style.display = 'none';
  iconPause.style.display = '';
  btnPlay.querySelector('span').textContent = 'Pause';
  playheadEl.style.display = '';
  lastStepTime = audioCtx.currentTime;
  scheduleStep();
  animate();
}

function stopPlayback() {
  playing = false;
  btnPlay.classList.remove('playing');
  iconPlay.style.display = '';
  iconPause.style.display = 'none';
  btnPlay.querySelector('span').textContent = 'Play';
  playheadEl.style.display = 'none';
  if (animId) cancelAnimationFrame(animId);
  animId = null;
  // Clear highlights
  gridEl.querySelectorAll('.col-highlight.active').forEach(h => h.classList.remove('active'));
  gridEl.querySelectorAll('.cell.triggered').forEach(c => c.classList.remove('triggered'));
}

function scheduleStep() {
  if (!playing) return;
  const stepDur = 60 / bpm / 2; // 8th notes
  const now = audioCtx.currentTime;

  // Schedule ahead
  while (lastStepTime <= now + 0.1) {
    triggerColumn(currentCol, lastStepTime);
    currentCol = (currentCol + 1) % COLS;
    lastStepTime += stepDur;
  }
}

function triggerColumn(col, time) {
  for (let r = 0; r < ROWS; r++) {
    if (grid[r][col]) {
      playNote(FREQS[r], time, instrument);
    }
  }
}

function animate() {
  if (!playing) return;
  animId = requestAnimationFrame(animate);

  scheduleStep();

  // Compute visual playhead position
  const stepDur = 60 / bpm / 2;
  const now = audioCtx.currentTime;
  const elapsed = now - (lastStepTime - stepDur);
  const frac = Math.max(0, Math.min(1, elapsed / stepDur));

  const cellW = gridEl.offsetWidth / COLS;
  const visualCol = ((currentCol - 1 + COLS) % COLS);
  playheadX = (visualCol + frac) * cellW;
  playheadEl.style.left = playheadX + 'px';

  // Auto scroll to keep playhead visible
  const scrollLeft = gridScroll.scrollLeft;
  const viewW = gridScroll.clientWidth;
  if (playheadX < scrollLeft + 30 || playheadX > scrollLeft + viewW - 30) {
    gridScroll.scrollLeft = playheadX - viewW / 3;
  }

  // Column highlight
  const highlights = gridEl.querySelectorAll('.col-highlight');
  highlights.forEach(h => {
    h.classList.toggle('active', +h.dataset.col === visualCol);
  });

  // Trigger animation on cells
  const cells = gridEl.querySelectorAll('.cell');
  cells.forEach(cell => {
    const r = +cell.dataset.row, c = +cell.dataset.col;
    cell.classList.toggle('triggered', c === visualCol && grid[r][c] === 1);
  });
}

// ─── Controls ───
btnPlay.addEventListener('click', () => {
  if (playing) { stopPlayback(); } else { startPlayback(); }
});

tempoSlider.addEventListener('input', () => {
  bpm = +tempoSlider.value;
  tempoVal.textContent = bpm;
});

instrumentSelect.addEventListener('change', () => {
  instrument = instrumentSelect.value;
});

btnClear.addEventListener('click', () => {
  for (let r = 0; r < ROWS; r++) grid[r].fill(0);
  rebuildCells();
  savePattern();
  showToast('Pattern cleared');
});

btnRandom.addEventListener('click', () => {
  for (let r = 0; r < ROWS; r++) {
    for (let c = 0; c < COLS; c++) {
      // Sparse random: ~12% density, favor middle notes
      const density = 0.08 + 0.06 * Math.exp(-Math.pow((r - ROWS/2) / (ROWS/3), 2));
      grid[r][c] = Math.random() < density ? 1 : 0;
    }
  }
  rebuildCells();
  savePattern();
  showToast('Random pattern generated');
});

function rebuildCells() {
  const cells = gridEl.querySelectorAll('.cell');
  cells.forEach(cell => {
    const r = +cell.dataset.row, c = +cell.dataset.col;
    cell.classList.toggle('pinned', !!grid[r][c]);
  });
  updatePinCount();
}

// ─── Share ───
btnShare.addEventListener('click', () => {
  const data = encodePattern();
  const url = location.origin + location.pathname + '#' + data;
  if (navigator.clipboard) {
    navigator.clipboard.writeText(url).then(() => {
      showToast('Link copied to clipboard!');
    }).catch(() => {
      fallbackCopy(url);
    });
  } else {
    fallbackCopy(url);
  }
  history.replaceState(null, '', '#' + data);
});

function fallbackCopy(text) {
  const ta = document.createElement('textarea');
  ta.value = text;
  ta.style.cssText = 'position:fixed;opacity:0';
  document.body.appendChild(ta);
  ta.select();
  document.execCommand('copy');
  ta.remove();
  showToast('Link copied!');
}

function encodePattern() {
  // Pack grid into base64: each bit = one pin
  const bits = [];
  for (let r = 0; r < ROWS; r++) {
    for (let c = 0; c < COLS; c++) {
      bits.push(grid[r][c]);
    }
  }
  const bytes = [];
  for (let i = 0; i < bits.length; i += 8) {
    let byte = 0;
    for (let b = 0; b < 8 && i + b < bits.length; b++) {
      byte |= (bits[i + b] << (7 - b));
    }
    bytes.push(byte);
  }
  // Add tempo and instrument
  bytes.push(bpm & 0xFF);
  bytes.push((['musicbox','piano','marimba'].indexOf(instrument)) & 0xFF);
  return btoa(String.fromCharCode(...bytes)).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
}

function decodePattern(hash) {
  try {
    let b64 = hash.replace(/-/g,'+').replace(/_/g,'/');
    while (b64.length % 4) b64 += '=';
    const str = atob(b64);
    const bytes = Array.from(str, c => c.charCodeAt(0));

    const instIdx = bytes.pop();
    const tempoVal = bytes.pop();

    const bits = [];
    for (const byte of bytes) {
      for (let b = 7; b >= 0; b--) {
        bits.push((byte >> b) & 1);
      }
    }

    for (let r = 0; r < ROWS; r++) {
      for (let c = 0; c < COLS; c++) {
        const idx = r * COLS + c;
        grid[r][c] = idx < bits.length ? bits[idx] : 0;
      }
    }

    bpm = Math.max(40, Math.min(240, tempoVal));
    tempoSlider.value = bpm;
    document.getElementById('tempo-val').textContent = bpm;

    const instruments = ['musicbox','piano','marimba'];
    instrument = instruments[instIdx] || 'musicbox';
    instrumentSelect.value = instrument;

    return true;
  } catch(e) {
    return false;
  }
}

// ─── LocalStorage ───
function savePattern() {
  try {
    const data = encodePattern();
    localStorage.setItem('musicbox-pattern', data);
  } catch(e) {}
}

function loadPattern() {
  // Priority: URL hash > localStorage
  if (location.hash.length > 1) {
    if (decodePattern(location.hash.slice(1))) return true;
  }
  try {
    const saved = localStorage.getItem('musicbox-pattern');
    if (saved) return decodePattern(saved);
  } catch(e) {}
  return false;
}

// ─── Toast ───
let toastTimer = null;
function showToast(msg) {
  toastEl.textContent = msg;
  toastEl.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => toastEl.classList.remove('show'), 2000);
}

// ─── Resize ───
let resizeTimer;
window.addEventListener('resize', () => {
  clearTimeout(resizeTimer);
  resizeTimer = setTimeout(() => buildGrid(), 150);
});

// ─── Init ───
loadPattern();
buildGrid();

// Listen for hash changes (shared links opened in same tab)
window.addEventListener('hashchange', () => {
  if (location.hash.length > 1) {
    if (decodePattern(location.hash.slice(1))) {
      rebuildCells();
      showToast('Pattern loaded from link');
    }
  }
});

})();
</script>
</body>
</html>
