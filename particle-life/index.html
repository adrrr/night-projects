<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Particle Life</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
html, body { width: 100%; height: 100%; overflow: hidden; background: #0a0a0f; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif; color: #fff; touch-action: none; user-select: none; -webkit-user-select: none; }
canvas { display: block; width: 100%; height: 100%; }

/* UI Overlay */
.ui { position: fixed; z-index: 10; }
.top-bar { top: 0; left: 0; right: 0; display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; background: linear-gradient(to bottom, rgba(10,10,15,0.9), transparent); pointer-events: none; }
.top-bar > * { pointer-events: auto; }
.title { font-size: 14px; font-weight: 700; letter-spacing: 1.5px; text-transform: uppercase; background: linear-gradient(135deg, #ff6b9d, #c084fc, #60a5fa); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
.stats { font-size: 11px; opacity: 0.5; font-variant-numeric: tabular-nums; }

/* Buttons */
.btn { background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.12); color: #fff; border-radius: 12px; padding: 8px 14px; font-size: 13px; font-weight: 500; cursor: pointer; backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); transition: all 0.2s; }
.btn:active { transform: scale(0.93); background: rgba(255,255,255,0.15); }

/* Bottom controls */
.bottom-bar { bottom: 0; left: 0; right: 0; display: flex; flex-direction: column; gap: 8px; padding: 0 16px 20px; background: linear-gradient(to top, rgba(10,10,15,0.95) 60%, transparent); }
.controls-row { display: flex; gap: 8px; justify-content: center; flex-wrap: wrap; }
.btn.active { background: rgba(255,255,255,0.18); border-color: rgba(255,255,255,0.3); box-shadow: 0 0 12px rgba(192,132,252,0.2); }

/* Species legend */
.legend { display: flex; gap: 10px; justify-content: center; padding: 6px 0; }
.legend-item { display: flex; align-items: center; gap: 4px; font-size: 11px; opacity: 0.7; }
.legend-dot { width: 8px; height: 8px; border-radius: 50%; }

/* Matrix overlay */
.matrix-overlay { position: fixed; inset: 0; z-index: 20; background: rgba(0,0,0,0.85); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); display: none; flex-direction: column; align-items: center; justify-content: center; gap: 16px; }
.matrix-overlay.show { display: flex; }
.matrix-title { font-size: 16px; font-weight: 600; opacity: 0.8; }
.matrix-grid { display: grid; gap: 2px; }
.matrix-cell { width: 44px; height: 44px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 600; cursor: pointer; transition: transform 0.15s; border: 1px solid rgba(255,255,255,0.05); }
.matrix-cell:active { transform: scale(0.9); }
.matrix-label { font-size: 10px; opacity: 0.5; text-align: center; max-width: 280px; line-height: 1.4; }
.matrix-header { width: 44px; height: 20px; display: flex; align-items: center; justify-content: center; }
.matrix-header .legend-dot { width: 10px; height: 10px; }
</style>
</head>
<body>
<canvas id="c"></canvas>

<div class="ui top-bar">
  <div class="title">Particle Life</div>
  <div class="stats" id="stats">0 fps</div>
</div>

<div class="ui bottom-bar">
  <div class="legend" id="legend"></div>
  <div class="controls-row">
    <button class="btn" id="btnShuffle" title="New rules">üé≤ Shuffle</button>
    <button class="btn" id="btnMatrix" title="Edit attraction matrix">‚öôÔ∏è Matrix</button>
    <button class="btn" id="btnPreset" title="Cycle presets">üß¨ Preset</button>
    <button class="btn" id="btnTrails" title="Toggle trails">‚ú® Trails</button>
  </div>
</div>

<div class="matrix-overlay" id="matrixOverlay">
  <div class="matrix-title">Attraction Matrix</div>
  <div class="matrix-label">Tap cells to randomize. Rows attract/repel columns.<br>Green = attract ¬∑ Red = repel</div>
  <div id="matrixGrid"></div>
  <button class="btn" id="btnCloseMatrix" style="margin-top:8px">‚úï Close</button>
</div>

<script>
const canvas = document.getElementById('c');
const ctx = canvas.getContext('2d');
const statsEl = document.getElementById('stats');

// Config
const NUM_SPECIES = 5;
const PARTICLES_PER_SPECIES = 120;
const TOTAL = NUM_SPECIES * PARTICLES_PER_SPECIES;
const RADIUS = 80;
const FRICTION = 0.15;
const DT = 0.02;
const FORCE_SCALE = 5;
const PARTICLE_SIZE = 2.2;

const COLORS = ['#ff6b9d','#c084fc','#60a5fa','#34d399','#fbbf24'];
const COLOR_NAMES = ['Pink','Purple','Blue','Green','Gold'];

let W, H;
let trails = true;
let matrix = [];
let px, py, vx, vy, species;

// Presets
const PRESETS = [
  { name:'Chaos', fn:()=>randomMatrix() },
  { name:'Symbiosis', fn:()=>{for(let i=0;i<NUM_SPECIES;i++)for(let j=0;j<NUM_SPECIES;j++)matrix[i][j]=i===j?-0.5:((j-i+NUM_SPECIES)%NUM_SPECIES===1?1:-0.3);}},
  { name:'Snakes', fn:()=>{for(let i=0;i<NUM_SPECIES;i++)for(let j=0;j<NUM_SPECIES;j++)matrix[i][j]=i===j?0.2:((j-i+NUM_SPECIES)%NUM_SPECIES===1?0.8:-0.6);}},
  { name:'Cells', fn:()=>{for(let i=0;i<NUM_SPECIES;i++)for(let j=0;j<NUM_SPECIES;j++)matrix[i][j]=i===j?0.6:-0.8;}},
  { name:'Orbit', fn:()=>{for(let i=0;i<NUM_SPECIES;i++)for(let j=0;j<NUM_SPECIES;j++){let d=(j-i+NUM_SPECIES)%NUM_SPECIES;matrix[i][j]=d===0?-0.2:d===1?0.7:d===2?0.3:-0.5;}}},
];
let presetIdx = 0;

function resize() {
  const dpr = Math.min(window.devicePixelRatio || 1, 2);
  W = window.innerWidth; H = window.innerHeight;
  canvas.width = W * dpr; canvas.height = H * dpr;
  ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
}

function randomMatrix() {
  matrix = [];
  for (let i = 0; i < NUM_SPECIES; i++) {
    matrix[i] = [];
    for (let j = 0; j < NUM_SPECIES; j++) {
      matrix[i][j] = Math.random() * 2 - 1;
    }
  }
}

function initParticles() {
  px = new Float32Array(TOTAL);
  py = new Float32Array(TOTAL);
  vx = new Float32Array(TOTAL);
  vy = new Float32Array(TOTAL);
  species = new Uint8Array(TOTAL);
  for (let i = 0; i < TOTAL; i++) {
    px[i] = Math.random() * W;
    py[i] = Math.random() * H;
    vx[i] = 0; vy[i] = 0;
    species[i] = Math.floor(i / PARTICLES_PER_SPECIES);
  }
}

function force(r, a) {
  const beta = 0.3;
  if (r < beta) return r / beta - 1;
  if (r < 1) return a * (1 - Math.abs(2 * r - 1 - beta) / (1 - beta));
  return 0;
}

function update() {
  for (let i = 0; i < TOTAL; i++) {
    let fx = 0, fy = 0;
    const si = species[i];
    for (let j = 0; j < TOTAL; j++) {
      if (i === j) continue;
      let dx = px[j] - px[i];
      let dy = py[j] - py[i];
      // Wrap
      if (dx > W * 0.5) dx -= W; else if (dx < -W * 0.5) dx += W;
      if (dy > H * 0.5) dy -= H; else if (dy < -H * 0.5) dy += H;
      const dist = Math.sqrt(dx * dx + dy * dy);
      if (dist > 0 && dist < RADIUS) {
        const f = force(dist / RADIUS, matrix[si][species[j]]);
        fx += (dx / dist) * f;
        fy += (dy / dist) * f;
      }
    }
    const totalF = FORCE_SCALE * RADIUS;
    vx[i] = vx[i] * (1 - FRICTION) + fx * totalF * DT;
    vy[i] = vy[i] * (1 - FRICTION) + fy * totalF * DT;
    px[i] += vx[i] * DT;
    py[i] += vy[i] * DT;
    // Wrap positions
    if (px[i] < 0) px[i] += W; else if (px[i] >= W) px[i] -= W;
    if (py[i] < 0) py[i] += H; else if (py[i] >= H) py[i] -= H;
  }
}

function draw() {
  if (trails) {
    ctx.fillStyle = 'rgba(10,10,15,0.15)';
    ctx.fillRect(0, 0, W, H);
  } else {
    ctx.fillStyle = '#0a0a0f';
    ctx.fillRect(0, 0, W, H);
  }

  for (let i = 0; i < TOTAL; i++) {
    const speed = Math.sqrt(vx[i]*vx[i]+vy[i]*vy[i]);
    const glow = Math.min(1, speed * 0.05 + 0.4);
    ctx.globalAlpha = glow;
    ctx.fillStyle = COLORS[species[i]];
    ctx.beginPath();
    ctx.arc(px[i], py[i], PARTICLE_SIZE + speed * 0.02, 0, Math.PI * 2);
    ctx.fill();
  }
  ctx.globalAlpha = 1;
}

// FPS
let frames = 0, lastFps = performance.now();
function loop() {
  update();
  draw();
  frames++;
  const now = performance.now();
  if (now - lastFps > 500) {
    statsEl.textContent = Math.round(frames / ((now - lastFps) / 1000)) + ' fps ¬∑ ' + TOTAL + ' particles';
    frames = 0; lastFps = now;
  }
  requestAnimationFrame(loop);
}

// Touch interaction ‚Äî push particles away
let touchX = -1, touchY = -1, touching = false;
function onPointerDown(e) { touching = true; touchX = e.clientX; touchY = e.clientY; }
function onPointerMove(e) { if (touching) { touchX = e.clientX; touchY = e.clientY; } }
function onPointerUp() { touching = false; }
canvas.addEventListener('pointerdown', onPointerDown);
canvas.addEventListener('pointermove', onPointerMove);
canvas.addEventListener('pointerup', onPointerUp);
canvas.addEventListener('pointercancel', onPointerUp);

// Apply touch force in update
const origUpdate = update;
update = function() {
  origUpdate();
  if (touching && touchX >= 0) {
    for (let i = 0; i < TOTAL; i++) {
      let dx = px[i] - touchX;
      let dy = py[i] - touchY;
      const dist = Math.sqrt(dx*dx+dy*dy);
      if (dist > 0 && dist < 100) {
        const f = (1 - dist/100) * 8;
        vx[i] += (dx/dist) * f;
        vy[i] += (dy/dist) * f;
      }
    }
  }
};

// Legend
function renderLegend() {
  const el = document.getElementById('legend');
  el.innerHTML = COLORS.map((c,i) => `<div class="legend-item"><div class="legend-dot" style="background:${c}"></div>${COLOR_NAMES[i]}</div>`).join('');
}

// Matrix UI
function renderMatrix() {
  const grid = document.getElementById('matrixGrid');
  const cols = NUM_SPECIES + 1;
  grid.style.gridTemplateColumns = `repeat(${cols}, 44px)`;
  let html = '<div class="matrix-cell" style="background:none;border:none"></div>';
  for (let j = 0; j < NUM_SPECIES; j++) html += `<div class="matrix-header"><div class="legend-dot" style="background:${COLORS[j]}"></div></div>`;
  for (let i = 0; i < NUM_SPECIES; i++) {
    html += `<div class="matrix-header"><div class="legend-dot" style="background:${COLORS[i]}"></div></div>`;
    for (let j = 0; j < NUM_SPECIES; j++) {
      const v = matrix[i][j];
      const bg = v > 0 ? `rgba(52,211,153,${v*0.6})` : `rgba(255,107,157,${-v*0.6})`;
      html += `<div class="matrix-cell" data-i="${i}" data-j="${j}" style="background:${bg}">${v.toFixed(1)}</div>`;
    }
  }
  grid.innerHTML = html;
  grid.querySelectorAll('.matrix-cell[data-i]').forEach(cell => {
    cell.addEventListener('click', () => {
      const i = +cell.dataset.i, j = +cell.dataset.j;
      matrix[i][j] = Math.round((Math.random() * 2 - 1) * 10) / 10;
      renderMatrix();
    });
  });
}

// Buttons
document.getElementById('btnShuffle').addEventListener('click', () => { randomMatrix(); renderMatrix(); });
document.getElementById('btnTrails').addEventListener('click', (e) => { trails = !trails; e.target.classList.toggle('active', trails); });
document.getElementById('btnMatrix').addEventListener('click', () => { renderMatrix(); document.getElementById('matrixOverlay').classList.add('show'); });
document.getElementById('btnCloseMatrix').addEventListener('click', () => { document.getElementById('matrixOverlay').classList.remove('show'); });
document.getElementById('btnPreset').addEventListener('click', (e) => {
  presetIdx = (presetIdx + 1) % PRESETS.length;
  PRESETS[presetIdx].fn();
  e.target.textContent = 'üß¨ ' + PRESETS[presetIdx].name;
  renderMatrix();
});

// Init
window.addEventListener('resize', resize);
resize();
randomMatrix();
initParticles();
renderLegend();
document.getElementById('btnTrails').classList.add('active');
requestAnimationFrame(loop);
</script>
</body>
</html>
